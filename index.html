<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Daggerheart Tracker iOS</title>
<style>
body, html { margin:0; padding:0; width:100vw; height:100vh; overflow-x:hidden; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; background:#000; color:#fff; }
header { padding:15px; text-align:center; font-size:1.2em; border-bottom:1px solid #333; position:relative; z-index:10; }
.section { position:absolute; top:60px; left:0; width:100%; height:calc(100vh - 120px); overflow-y:auto; overflow-x:hidden; padding:10px; transition: opacity 0.3s ease; }
.section:not(.active) { display:none; opacity:0; pointer-events:none; }
.character, .npc { display:flex; background:#111; padding:10px; border-radius:12px; margin-bottom:10px; align-items:flex-start; }
.char-left, .npc-left { width:80px; display:flex; flex-direction:column; align-items:center; margin-right:10px; }
.avatar-preview { width:80px; min-height:80px; object-fit:cover; border-radius:8px; border:1px solid #333; margin-bottom:5px; cursor:pointer; transition:transform 0.2s ease, height 0.2s ease; }
.char-right, .npc-right { flex:1; }
input[type=text] { width:180px; padding:5px; margin-left:5px; border-radius:8px; border:1px solid #333; background:#222; color:#fff; }
.stat { margin-top:8px; display:flex; align-items:center; gap:5px; }
.stat-label { width:70px; }
.block { width:25px; height:25px; border-radius:5px; border:1px solid #333; cursor:pointer; background:#111; transition:all 0.2s; }
.block.hp-filled { background:green; }
.block.stress-filled { background:red; }
.hope .star { font-size:20px; cursor:pointer; color:gray; transition:transform 0.2s; }
.hope .star.filled { color:gold; transform:scale(1.2); }
button { margin-top:8px; padding:5px 12px; border:none; border-radius:10px; background:#222; color:#fff; cursor:pointer; }
button:hover { background:#333; }
.tabs { display:flex; margin-bottom:5px; gap:5px; overflow-x:auto; align-items:center; }
.tab { padding:5px 10px; border-radius:8px; background:#222; cursor:pointer; white-space:nowrap; display:flex; align-items:center; gap:5px; }
.tab.active { background:#555; }
.tab-content { display:none; margin-top:5px; height:calc(100% - 40px); overflow-y:auto; overflow-x:hidden; }
.tab-content.active { display:block; }
textarea { width:100%; height:80px; resize:vertical; border-radius:8px; border:1px solid #333; background:#111; color:#fff; padding:5px; margin-bottom:5px;}
.avatar-input { display:none; }
.remove-btn { background:#800; color:#fff; font-size:14px; border-radius:8px; padding:2px 6px; cursor:pointer; }
.remove-btn:hover { background:#a00; }
#tab-bar { position:fixed; bottom:0; left:0; width:100%; display:flex; justify-content:space-around; background:#111; border-top:1px solid #333; padding:10px 0; z-index:20; }
#tab-bar button { flex:1; margin:0 5px; padding:8px 0; border-radius:12px; border:none; background:#222; color:#fff; font-size:16px; cursor:pointer; transition: all 0.2s; }
#tab-bar button:hover { background:#333; }
#tab-bar button.active { background:#555; font-weight:bold; }
#add-note-btn { width:30px; height:30px; border-radius:50%; background:#222; color:#fff; display:flex; align-items:center; justify-content:center; cursor:pointer; font-weight:bold; font-size:18px; flex-shrink:0; transition:background 0.2s; margin-left:5px; }
#add-note-btn:hover { background:#555; }
.edit-name-btn { margin-left:5px; cursor:pointer; opacity:0.5; font-size:14px; transition:opacity 0.2s; }
.edit-name-btn:hover { opacity:1; }
</style>
</head>
<body>

<header>Daggerheart Tracker iOS</header>

<div class="section active" id="characters-section">
  <h2>–ü–µ—Ä—Å–æ–Ω–∞–∂–∏</h2>
  <div id="characters-container"></div>
  <button onclick="addCharacter()">–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</button>
</div>

<div class="section" id="npc-section">
  <h2>NPC / –ë–æ–π</h2>
  <div id="npc-container"></div>
  <button onclick="addNPC()">–î–æ–±–∞–≤–∏—Ç—å NPC</button>
</div>

<div class="section" id="notes-section">
  <h2 style="display:flex; align-items:center; gap:8px;">
    –ó–∞–º–µ—Ç–∫–∏
    <div id="add-note-btn">+</div>
  </h2>
  <div class="tabs" id="notes-tabs"></div>
  <div id="notes-contents"></div>
</div>

<div id="tab-bar">
  <button onclick="switchSection(0)">–ü–µ—Ä—Å–æ–Ω–∞–∂–∏</button>
  <button onclick="switchSection(1)">NPC</button>
  <button onclick="switchSection(2)">–ó–∞–º–µ—Ç–∫–∏</button>
</div>

<script>
// ===== LocalStorage =====
function saveData(){
  const characters = [];
  document.querySelectorAll('.character').forEach(c=>{
    characters.push({
      avatar:c.querySelector('.avatar-preview').src,
      name:c.querySelector('.name-input').value,
      hp:Array.from(c.querySelectorAll('.block.hp')).map(b=>b.classList.contains('hp-filled')),
      stress:Array.from(c.querySelectorAll('.block.stress')).map(b=>b.classList.contains('stress-filled')),
      hope:Array.from(c.querySelectorAll('.hope .star')).map(s=>s.classList.contains('filled'))
    });
  });
  const npcs=[];
  document.querySelectorAll('.npc').forEach(n=>{
    npcs.push({
      avatar:n.querySelector('.avatar-preview').src,
      name:n.querySelector('.npc-name').value,
      hp:Array.from(n.querySelectorAll('.block.hp')).map(b=>b.classList.contains('hp-filled')),
      stress:Array.from(n.querySelectorAll('.block.stress')).map(b=>b.classList.contains('stress-filled')),
      hope:Array.from(n.querySelectorAll('.hope .star')).map(s=>s.classList.contains('filled'))
    });
  });
  const notes=[];
  document.querySelectorAll('.tab').forEach(tab=>{
    const id=tab.dataset.tab;
    const content=document.getElementById('tab-content-'+id);
    const blocks=Array.from(content.querySelectorAll('textarea')).map(ta=>ta.value);
    notes.push({title:tab.querySelector('.tab-title').textContent,texts:blocks});
  });
  localStorage.setItem('daggerheart',JSON.stringify({characters,npcs,notes}));
}

function loadData(){
  const data=JSON.parse(localStorage.getItem('daggerheart')||'{}');
  if(data.characters) data.characters.forEach(c=>addCharacter(c));
  if(data.npcs) data.npcs.forEach(n=>addNPC(n));
  if(data.notes){ noteCounter=0; data.notes.forEach(n=>addNoteTab(n.title,n.texts)); }
}

// ===== RPG-—Å—Ç–∞—Ç –±–ª–æ–∫–∏ =====
function createBlockRow(label,type,values){
  const div=document.createElement('div'); div.className='stat';
  const lbl=document.createElement('div'); lbl.className='stat-label'; lbl.textContent=label;
  div.appendChild(lbl);
  const blocks=[];
  for(let i=0;i<7;i++){
    const block=document.createElement('div'); block.className='block '+type;
    if(values&&values[i]) block.classList.add(type+'-filled');
    block.addEventListener('click',()=>{
      if(i===0 && block.classList.contains(type+'-filled')){
        blocks.forEach(b=>b.classList.remove(type+'-filled'));
      } else {
        blocks.forEach((b,idx)=>{
          if(idx<=i) b.classList.add(type+'-filled');
          else b.classList.remove(type+'-filled');
        });
      }
      block.animate([{transform:'scale(0.8)'},{transform:'scale(1)'}],{duration:150});
      saveData();
    });
    blocks.push(block);
    div.appendChild(block);
  }
  return div;
}

function createHopeRow(values){
  const div=document.createElement('div'); div.className='stat hope';
  const lbl=document.createElement('div'); lbl.className='stat-label'; lbl.textContent='–ù–∞–¥–µ–∂–¥–∞';
  div.appendChild(lbl);
  const stars=[];
  for(let i=0;i<7;i++){
    const star=document.createElement('span'); star.className='star';
    star.textContent=values&&values[i]?'‚òÖ':'‚òÜ';
    if(values&&values[i]) star.classList.add('filled');
    star.addEventListener('click',()=>{
      const allStars=Array.from(div.querySelectorAll('.star'));
      if(i===0 && star.classList.contains('filled')){
        allStars.forEach(s=>{ s.classList.remove('filled'); s.textContent='‚òÜ'; });
      } else {
        allStars.forEach((s,idx)=>{
          if(idx<=i){ s.classList.add('filled'); s.textContent='‚òÖ'; s.animate([{transform:'scale(0.8)'},{transform:'scale(1)'}],{duration:150}); }
          else{ s.classList.remove('filled'); s.textContent='‚òÜ'; }
        });
      }
      saveData();
    });
    stars.push(star);
    div.appendChild(star);
  }
  return div;
}

// ===== Avatar logic =====
function addAvatarLogic(div){
  const input=div.querySelector('.avatar-input'); const img=div.querySelector('.avatar-preview');
  input.addEventListener('change',()=>{ const file=input.files[0]; if(file){ const reader=new FileReader(); reader.onload=e=>{ img.src=e.target.result; saveData(); }; reader.readAsDataURL(file); } });
  img.addEventListener('click',()=>input.click());
}

// ===== Resize avatar =====
function resizeAvatar(div){
  const avatar = div.querySelector('.avatar-preview');
  const right = div.querySelector('.char-right, .npc-right');
  const rightHeight = right.offsetHeight;
  avatar.style.height = Math.max(rightHeight, 80) + 'px'; // –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è 80px
}
window.addEventListener('resize',()=>{
  document.querySelectorAll('.character, .npc').forEach(resizeAvatar);
});

// ===== –ü–µ—Ä—Å–æ–Ω–∞–∂–∏ =====
function addCharacter(data){
  const div=document.createElement('div'); div.className='character';
  div.innerHTML=`<div class="char-left"><img class="avatar-preview" src="${data?.avatar||''}"/><input type="file" class="avatar-input" accept="image/*"/></div>
  <div class="char-right">–ò–º—è: <input type="text" class="name-input" placeholder="–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" value="${data?.name||''}" readonly>
  <span class="edit-name-btn">‚úé</span>
  <button class="remove-btn" onclick="removeCharacter(this)">üóëÔ∏è</button></div>`;
  const editBtn=div.querySelector('.edit-name-btn'); const nameInput=div.querySelector('.name-input');
  editBtn.addEventListener('click',()=>{
    const newName=prompt('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞',nameInput.value);
    if(newName) nameInput.value=newName; saveData();
  });
  div.querySelector('.char-right').appendChild(createBlockRow('HP','hp',data?.hp));
  div.querySelector('.char-right').appendChild(createBlockRow('Stress','stress',data?.stress));
  div.querySelector('.char-right').appendChild(createHopeRow(data?.hope));
  document.getElementById('characters-container').appendChild(div);
  addAvatarLogic(div);
  resizeAvatar(div);
  saveData();
}
function removeCharacter(btn){ btn.closest('.character').remove(); saveData(); }

// ===== NPC =====
function addNPC(data){
  const div=document.createElement('div'); div.className='npc';
  div.innerHTML=`<div class="npc-left"><img class="avatar-preview" src="${data?.avatar||''}"/><input type="file" class="avatar-input" accept="image/*"/></div>
  <div class="npc-right">–ò–º—è: <input type="text" class="npc-name" placeholder="NPC" value="${data?.name||''}" readonly>
  <span class="edit-name-btn">‚úé</span>
  <button class="remove-btn" onclick="removeNPC(this)">üóëÔ∏è</button></div>`;
  const editBtn=div.querySelector('.edit-name-btn'); const nameInput=div.querySelector('.npc-name');
  editBtn.addEventListener('click',()=>{
    const newName=prompt('–í–≤–µ–¥–∏—Ç–µ –∏–º—è NPC',nameInput.value);
    if(newName) nameInput.value=newName; saveData();
  });
  div.querySelector('.npc-right').appendChild(createBlockRow('HP','hp',data?.hp));
  div.querySelector('.npc-right').appendChild(createBlockRow('Stress','stress',data?.stress));
  div.querySelector('.npc-right').appendChild(createHopeRow(data?.hope));
  document.getElementById('npc-container').appendChild(div);
  addAvatarLogic(div);
  resizeAvatar(div);
  saveData();
}
function removeNPC(btn){ btn.closest('.npc').remove(); saveData(); }

// ===== –ó–∞–º–µ—Ç–∫–∏ =====
let noteCounter=0; const scrollPositions={};
function addNoteTab(title,blocks){
  const id=noteCounter++; const tabs=document.getElementById('notes-tabs'); const contents=document.getElementById('notes-contents');
  const tab=document.createElement('div'); tab.className='tab'; tab.dataset.tab=id;
  const titleSpan=document.createElement('span'); titleSpan.className='tab-title'; titleSpan.textContent=title||'–ù–æ–≤–∞—è –∑–∞–º–µ—Ç–∫–∞';
  titleSpan.addEventListener('click',()=>switchNoteTab(id));
  const editBtn=document.createElement('span'); editBtn.className='edit-btn'; editBtn.textContent='‚úé'; editBtn.style.opacity='0.5'; editBtn.style.cursor='pointer';
  editBtn.addEventListener('click',(e)=>{ e.stopPropagation(); const newTitle=prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏',titleSpan.textContent); if(newTitle) titleSpan.textContent=newTitle; saveData(); });
  const removeBtn=document.createElement('span'); removeBtn.className='remove-btn'; removeBtn.textContent='üóëÔ∏è';
  removeBtn.addEventListener('click',(e)=>{ e.stopPropagation(); removeNoteTab(id); });
  tab.appendChild(titleSpan); tab.appendChild(editBtn); tab.appendChild(removeBtn);
  tabs.appendChild(tab);
  const content=document.createElement('div'); content.className='tab-content'; content.id='tab-content-'+id;
  (blocks||[]).forEach(text=>{ const ta=document.createElement('textarea'); ta.value=text; ta.addEventListener('input',saveData); content.appendChild(ta); });
  const addBlockBtn=document.createElement('button'); addBlockBtn.textContent='+ –î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫';
  addBlockBtn.onclick=()=>{ const ta=document.createElement('textarea'); ta.addEventListener('input',saveData); content.appendChild(ta); saveData(); };
  content.appendChild(addBlockBtn); contents.appendChild(content);
  switchNoteTab(id); saveData();
}
function removeNoteTab(id){ document.querySelector(`.tab[data-tab='${id}']`)?.remove(); document.getElementById('tab-content-'+id)?.remove(); saveData(); }
function switchNoteTab(id){
  const current=document.querySelector('.tab-content.active');
  if(current) scrollPositions[current.id]=current.scrollTop;
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  const tab=document.querySelector(`.tab[data-tab='${id}']`); if(tab) tab.classList.add('active');
  const content=document.getElementById('tab-content-'+id); content.classList.add('active');
  content.scrollTop = scrollPositions[content.id]||0;
}

// ===== –ù–∞–≤–∏–≥–∞—Ü–∏—è =====
function switchSection(index){
  const sections=['characters-section','npc-section','notes-section'];
  sections.forEach((sec,i)=>document.getElementById(sec).classList.toggle('active',i===index));
  document.querySelectorAll('#tab-bar button').forEach((b,i)=>b.classList.toggle('active',i===index));
}

// ===== INIT =====
loadData(); switchSection(0);

// ===== Enter / Shift+Enter =====
document.addEventListener('keydown', e => {
  if(e.target.tagName==='TEXTAREA'){
    if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); e.target.blur(); saveData(); }
  }
});
document.addEventListener('input', e => {
  if(e.target.tagName==='TEXTAREA'){ e.target.style.height='auto'; e.target.style.height=e.target.scrollHeight+'px'; }
});

// ===== –ö–Ω–æ–ø–∫–∞ + –¥–ª—è –∑–∞–º–µ—Ç–æ–∫ =====
document.getElementById('add-note-btn').addEventListener('click', ()=>addNoteTab());
</script>

</body>
</html>
