<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daggerheart Tracker</title>
<style>
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; margin: 0; padding: 0; background: #f4f4f4; color: #333; }
header { padding: 15px; background: #2E86AB; color: white; text-align: center; font-size: 1.2em; }
.section { padding: 20px; min-height: 80vh; display: none; overflow-y: auto; }
.section.active { display: block; }
.character, .npc { background: #fff; padding: 10px; border-radius: 8px; margin-bottom: 10px; text-align: left; box-shadow: 0 1px 3px rgba(0,0,0,0.1);}
.char-name input, .npc-name input { width: 180px; padding: 3px 5px; margin-left: 5px; }
.stat { margin-top: 5px; }
.hp input, .stress input { width: 30px; height: 20px; margin-right: 3px; accent-color: #2E86AB; }
.hope .star { font-size: 20px; cursor: pointer; color: gray; }
.hope .star.filled { color: gold; }
button { margin-top: 5px; padding: 5px 10px; border: none; border-radius: 5px; background: #2E86AB; color: white; cursor: pointer; }
button:hover { background: #1B4F72; }
.tabs { display: flex; margin-bottom: 5px; gap: 5px; overflow-x: auto; }
.tab { padding: 5px 10px; border-radius: 5px; background: #ddd; cursor: pointer; white-space: nowrap; }
.tab.active { background: #2E86AB; color: white; }
.tab-content { display: none; margin-top: 5px; }
.tab-content.active { display: block; }
textarea { width: 100%; height: 80px; resize: vertical; }
</style>
</head>
<body>

<header>Daggerheart Tracker (Свайпы: Влево/Вправо)</header>

<!-- Персонажи -->
<div class="section active" id="characters-section">
  <h2>Персонажи</h2>
  <div id="characters-container"></div>
  <button onclick="addCharacter()">Добавить персонажа</button>
</div>

<!-- NPC -->
<div class="section" id="npc-section">
  <h2>NPC / Бой</h2>
  <div id="npc-container"></div>
  <button onclick="addNPC()">Добавить NPC</button>
</div>

<!-- Заметки -->
<div class="section" id="notes-section">
  <h2>Заметки</h2>
  <div class="tabs" id="notes-tabs"></div>
  <div id="notes-contents"></div>
  <button onclick="addNoteTab()">Добавить вкладку</button>
</div>

<script>
// ===== LocalStorage Helpers =====
function saveData() {
  const characters = [];
  document.querySelectorAll('.character').forEach(c => {
    characters.push({
      name: c.querySelector('.name-input').value,
      hp: Array.from(c.querySelectorAll('.hp input')).map(i => i.checked),
      stress: Array.from(c.querySelectorAll('.stress input')).map(i => i.checked),
      hope: Array.from(c.querySelectorAll('.hope .star')).map(s => s.classList.contains('filled'))
    });
  });
  const npcs = [];
  document.querySelectorAll('.npc').forEach(n => {
    npcs.push({
      name: n.querySelector('.npc-name').value,
      hp: Array.from(n.querySelectorAll('.hp input')).map(i => i.checked),
      stress: Array.from(n.querySelectorAll('.stress input')).map(i => i.checked),
      hope: Array.from(n.querySelectorAll('.hope .star')).map(s => s.classList.contains('filled'))
    });
  });
  const notes = [];
  document.querySelectorAll('.tab').forEach(tab => {
    const id = tab.dataset.tab;
    const content = document.getElementById('tab-content-' + id);
    notes.push({
      title: tab.textContent,
      text: content.querySelector('textarea').value
    });
  });
  localStorage.setItem('daggerheart', JSON.stringify({characters, npcs, notes}));
}

function loadData() {
  const data = JSON.parse(localStorage.getItem('daggerheart') || '{}');
  if(data.characters) data.characters.forEach(c => addCharacter(c));
  if(data.npcs) data.npcs.forEach(n => addNPC(n));
  if(data.notes) {
    noteCounter = 0;
    data.notes.forEach(n => addNoteTab(n.title, n.text));
  }
}

// ===== Персонажи / NPC =====
function createStatRow(label, type, values) {
  const div = document.createElement('div');
  div.className = 'stat';
  div.innerHTML = label + ': ';
  const container = document.createElement('span');
  container.className = type;
  for (let i = 0; i < 7; i++) {
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    if(values && values[i]) checkbox.checked = true;
    checkbox.addEventListener('change', saveData);
    container.appendChild(checkbox);
  }
  div.appendChild(container);
  return div;
}

function createHopeRow(values) {
  const div = document.createElement('div');
  div.className = 'stat';
  div.innerHTML = 'Hope: ';
  const container = document.createElement('span');
  container.className = 'hope';
  for (let i = 0; i < 7; i++) {
    const star = document.createElement('span');
    star.className = 'star';
    star.dataset.value = i + 1;
    star.textContent = (values && values[i]) ? '★' : '☆';
    if(values && values[i]) star.classList.add('filled');
    star.addEventListener('click', () => {
      container.querySelectorAll('.star').forEach((s, idx) => {
        if(idx <= i) { s.classList.add('filled'); s.textContent='★'; }
        else { s.classList.remove('filled'); s.textContent='☆'; }
      });
      saveData();
    });
    container.appendChild(star);
  }
  div.appendChild(container);
  return div;
}

function addCharacter(data) {
  const div = document.createElement('div');
  div.className = 'character';
  div.innerHTML = 'Имя: <input type="text" class="name-input" placeholder="Имя персонажа">';
  if(data && data.name) div.querySelector('.name-input').value = data.name;
  div.querySelector('.name-input').addEventListener('input', saveData);
  div.appendChild(createStatRow('HP','hp', data?.hp));
  div.appendChild(createStatRow('Stress','stress', data?.stress));
  div.appendChild(createHopeRow(data?.hope));
  document.getElementById('characters-container').appendChild(div);
  saveData();
}

function addNPC(data) {
  const div = document.createElement('div');
  div.className = 'npc';
  div.innerHTML = 'Имя: <input type="text" class="npc-name" placeholder="Имя NPC">';
  if(data && data.name) div.querySelector('.npc-name').value = data.name;
  div.querySelector('.npc-name').addEventListener('input', saveData);
  div.appendChild(createStatRow('HP','hp', data?.hp));
  div.appendChild(createStatRow('Stress','stress', data?.stress));
  div.appendChild(createHopeRow(data?.hope));
  document.getElementById('npc-container').appendChild(div);
  saveData();
}

// ===== Заметки =====
let noteCounter = 0;
function addNoteTab(title, text) {
  noteCounter++;
  const tab = document.createElement('div');
  tab.className = 'tab';
  tab.textContent = title || 'Tab ' + noteCounter;
  tab.dataset.tab = noteCounter;
  tab.addEventListener('click', () => selectNoteTab(noteCounter));
  document.getElementById('notes-tabs').appendChild(tab);

  const content = document.createElement('div');
  content.className = 'tab-content';
  content.id = 'tab-content-' + noteCounter;
  const textarea = document.createElement('textarea');
  if(text) textarea.value = text;
  textarea.addEventListener('input', saveData);
  content.appendChild(textarea);
  document.getElementById('notes-contents').appendChild(content);

  selectNoteTab(noteCounter);
  saveData();
}

function selectNoteTab(id) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  const tab = document.querySelector(`.tab[data-tab='${id}']`);
  if(tab) tab.classList.add('active');
  const content = document.getElementById('tab-content-' + id);
  if(content) content.classList.add('active');
}

// ===== Свайпы между секциями =====
const sections = ['characters-section', 'npc-section', 'notes-section'];
let currentSection = 0;

function showSection(index) {
  document.querySelectorAll('.section').forEach((sec, idx) => {
    sec.classList.toggle('active', idx === index);
  });
  currentSection = index;
}

let startX = 0;
document.addEventListener('touchstart', e => { startX = e.touches[0].clientX; });
document.addEventListener('touchend', e => {
  const endX = e.changedTouches[0].clientX;
  if(endX - startX > 50) showSection(Math.max(0, currentSection - 1));
  if(startX - endX > 50) showSection(Math.min(sections.length - 1, currentSection + 1));
});

// Стрелки на клавиатуре
document.addEventListener('keydown', e => {
  if(e.key === 'ArrowLeft') showSection(Math.max(0, currentSection - 1));
  if(e.key === 'ArrowRight') showSection(Math.min(sections.length - 1, currentSection + 1));
});

// ===== Инициализация =====
loadData();
if(document.getElementById('characters-container').children.length===0) addCharacter();
if(document.getElementById('npc-container').children.length===0) addNPC();
if(document.getElementById('notes-tabs').children.length===0) addNoteTab();
</script>
</body>
</html>
