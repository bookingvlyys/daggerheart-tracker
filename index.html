<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daggerheart Tracker iOS</title>
<style>
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; margin: 0; padding: 0; background: #000; color: #fff; overflow-x: hidden;}
header { padding: 15px; text-align: center; font-size: 1.2em; border-bottom: 1px solid #333; position: relative; z-index: 10; }
.section { position: absolute; top: 60px; left: 0; width: 100%; padding: 20px; min-height: calc(100vh - 60px); overflow-y: auto; background: #000; color: #fff; transition: transform 0.3s ease, opacity 0.3s ease; }
.section:not(.active) { opacity: 0; pointer-events: none; }
.section.active { opacity: 1; pointer-events: auto; }
.character, .npc { display: flex; background: #111; padding: 10px; border-radius: 12px; margin-bottom: 10px; align-items: flex-start; }
.char-left, .npc-left { width: 60px; display: flex; flex-direction: column; align-items: center; margin-right: 10px; }
.avatar-preview { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 1px solid #333; margin-bottom: 5px; cursor: pointer; transition: transform 0.2s ease; }
.avatar-preview.clicked { transform: scale(1.2); }
.char-right, .npc-right { flex: 1; }
input[type=text] { width: 180px; padding: 5px; margin-left: 5px; border-radius: 8px; border: 1px solid #333; background: #222; color: #fff; }
.stat { margin-top: 8px; display: flex; align-items: center; gap: 5px; }
.stat-label { width: 70px; }
.block { width: 25px; height: 25px; border-radius: 5px; border: 1px solid #333; cursor: pointer; background: #111; transition: all 0.2s; }
.block.hp-filled { background: #0f0; }
.block.stress-filled { background: #555; }
.hope .star { font-size: 20px; cursor: pointer; color: gray; transition: transform 0.2s; }
.hope .star.filled { color: gold; transform: scale(1.2); }
button { margin-top: 8px; padding: 5px 12px; border: none; border-radius: 10px; background: #222; color: #fff; cursor: pointer; }
button:hover { background: #333; }
.tabs { display: flex; margin-bottom: 5px; gap: 5px; overflow-x: auto; }
.tab { padding: 5px 10px; border-radius: 8px; background: #222; cursor: pointer; white-space: nowrap; display: flex; align-items: center; gap: 5px; opacity: 1; transform: scale(1); transition: all 0.3s ease;}
.tab.active { background: #555; }
.tab-content { display: none; margin-top: 5px; opacity: 0; transform: scale(0.95); transition: all 0.3s ease; }
.tab-content.active { display: block; opacity: 1; transform: scale(1); }
textarea { width: 100%; height: 80px; resize: vertical; border-radius: 8px; border: 1px solid #333; background: #111; color: #fff; padding: 5px; }
.avatar-input { display: none; }
.fade-in { animation: fadeIn 0.3s forwards; }
.fade-out { animation: fadeOut 0.3s forwards; }
@keyframes fadeIn { from {opacity: 0; transform: scale(0.8);} to {opacity: 1; transform: scale(1);} }
@keyframes fadeOut { from {opacity: 1; transform: scale(1);} to {opacity: 0; transform: scale(0.8);} }
.remove-btn { background: #800; color: #fff; font-size: 14px; border-radius: 8px; padding: 2px 6px; cursor:pointer;}
.remove-btn:hover { background: #a00; }
</style>
</head>
<body>

<header>Daggerheart Tracker iOS</header>

<div class="section active" id="characters-section">
  <h2>–ü–µ—Ä—Å–æ–Ω–∞–∂–∏</h2>
  <div id="characters-container"></div>
  <button onclick="addCharacter()">–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</button>
</div>

<div class="section" id="npc-section">
  <h2>NPC / –ë–æ–π</h2>
  <div id="npc-container"></div>
  <button onclick="addNPC()">–î–æ–±–∞–≤–∏—Ç—å NPC</button>
</div>

<div class="section" id="notes-section">
  <h2>–ó–∞–º–µ—Ç–∫–∏</h2>
  <div class="tabs" id="notes-tabs"></div>
  <div id="notes-contents"></div>
  <button onclick="addNoteTab()">–î–æ–±–∞–≤–∏—Ç—å –≤–∫–ª–∞–¥–∫—É</button>
</div>

<script>
// ===== LocalStorage =====
function saveData() {
  const characters = [];
  document.querySelectorAll('.character').forEach(c => {
    characters.push({
      avatar: c.querySelector('.avatar-preview').src,
      name: c.querySelector('.name-input').value,
      hp: Array.from(c.querySelectorAll('.block.hp')).map(b => b.classList.contains('hp-filled')),
      stress: Array.from(c.querySelectorAll('.block.stress')).map(b => b.classList.contains('stress-filled')),
      hope: Array.from(c.querySelectorAll('.hope .star')).map(s => s.classList.contains('filled'))
    });
  });
  const npcs = [];
  document.querySelectorAll('.npc').forEach(n => {
    npcs.push({
      avatar: n.querySelector('.avatar-preview').src,
      name: n.querySelector('.npc-name').value,
      hp: Array.from(n.querySelectorAll('.block.hp')).map(b => b.classList.contains('hp-filled')),
      stress: Array.from(n.querySelectorAll('.block.stress')).map(b => b.classList.contains('stress-filled')),
      hope: Array.from(n.querySelectorAll('.hope .star')).map(s => s.classList.contains('filled'))
    });
  });
  const notes = [];
  document.querySelectorAll('.tab').forEach(tab => {
    const id = tab.dataset.tab;
    const content = document.getElementById('tab-content-' + id);
    notes.push({ title: tab.textContent.replace('üóëÔ∏è',''), text: content.querySelector('textarea').value });
  });
  localStorage.setItem('daggerheart', JSON.stringify({characters, npcs, notes}));
}

function loadData() {
  const data = JSON.parse(localStorage.getItem('daggerheart') || '{}');
  if(data.characters) data.characters.forEach(c => addCharacter(c));
  if(data.npcs) data.npcs.forEach(n => addNPC(n));
  if(data.notes) { noteCounter = 0; data.notes.forEach(n => addNoteTab(n.title, n.text)); }
}

// ===== –°—Ç–∞—Ç –±–ª–æ–∫–∏ =====
function createBlockRow(label, type, values) {
  const div = document.createElement('div'); div.className='stat';
  const lbl = document.createElement('div'); lbl.className='stat-label'; lbl.textContent=label;
  div.appendChild(lbl);
  for(let i=0;i<7;i++){
    const block=document.createElement('div'); block.className='block '+type;
    if(values && values[i]) block.classList.add(type==='hp'?'hp-filled':'stress-filled');
    block.addEventListener('click', ()=>{
      block.classList.toggle(type==='hp'?'hp-filled':'stress-filled');
      block.animate([{transform:'scale(0.8)'},{transform:'scale(1)'}], {duration:150});
      saveData();
    });
    div.appendChild(block);
  }
  return div;
}

function createHopeRow(values){
  const div=document.createElement('div'); div.className='stat';
  const lbl=document.createElement('div'); lbl.className='stat-label'; lbl.textContent='Hope';
  div.appendChild(lbl);
  const container=document.createElement('span'); container.className='hope';
  for(let i=0;i<7;i++){
    const star=document.createElement('span'); star.className='star'; star.dataset.value=i+1; star.textContent=(values&&values[i])?'‚òÖ':'‚òÜ';
    if(values&&values[i]) star.classList.add('filled');
    star.addEventListener('click', ()=>{
      container.querySelectorAll('.star').forEach((s,idx)=>{
        if(idx<=i){ s.classList.add('filled'); s.textContent='‚òÖ'; s.animate([{transform:'scale(0.8)'},{transform:'scale(1)'}],{duration:150}); }
        else{s.classList.remove('filled'); s.textContent='‚òÜ';}
      });
      saveData();
    });
    container.appendChild(star);
  }
  div.appendChild(container); return div;
}

// ===== –ê–≤–∞—Ç–∞—Ä =====
function addAvatarLogic(div){
  const input = div.querySelector('.avatar-input');
  const preview = div.querySelector('.avatar-preview');
  preview.addEventListener('click', ()=>{
    preview.classList.add('clicked');
    setTimeout(()=>preview.classList.remove('clicked'),200);
    input.click();
  });
  input.addEventListener('change', e=>{
    const file = e.target.files[0];
    if(file){
      const reader = new FileReader();
      reader.onload = function(ev){
        preview.src = ev.target.result;
        preview.animate([{transform:'scale(0.8)'},{transform:'scale(1)'}], {duration:200});
        saveData();
      };
      reader.readAsDataURL(file);
    }
  });
}

// ===== –ü–µ—Ä—Å–æ–Ω–∞–∂–∏ =====
function addCharacter(data){
  const div=document.createElement('div'); div.className='character fade-in';
  div.innerHTML=`
    <div class="char-left">
      <img class="avatar-preview" src="${data?.avatar||''}" alt="–ê–≤–∞—Ç–∞—Ä"/>
      <input type="file" class="avatar-input" accept="image/*"/>
    </div>
    <div class="char-right">
      –ò–º—è: <input type="text" class="name-input" placeholder="–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞">
      <button class="remove-btn" onclick="removeCharacter(this)">üóëÔ∏è</button>
    </div>
  `;
  if(data?.name) div.querySelector('.name-input').value=data.name;
  div.querySelector('.name-input').addEventListener('input',saveData);
  addAvatarLogic(div);
  div.querySelector('.char-right').appendChild(createBlockRow('HP','hp', data?.hp));
  div.querySelector('.char-right').appendChild(createBlockRow('Stress','stress', data?.stress));
  div.querySelector('.char-right').appendChild(createHopeRow(data?.hope));
  document.getElementById('characters-container').appendChild(div);
  setTimeout(()=>div.classList.remove('fade-in'),300);
  saveData();
}

function removeCharacter(btn){
  const div=btn.closest('.character');
  div.classList.add('fade-out');
  setTimeout(()=>{ div.remove(); saveData(); },300);
}

// ===== NPC =====
function addNPC(data){
  const div=document.createElement('div'); div.className='npc fade-in';
  div.innerHTML=`
    <div class="npc-left">
      <img class="avatar-preview" src="${data?.avatar||''}" alt="–ê–≤–∞—Ç–∞—Ä"/>
      <input type="file" class="avatar-input" accept="image/*"/>
    </div>
    <div class="npc-right">
      –ò–º—è: <input type="text" class="npc-name" placeholder="–ò–º—è NPC">
      <button class="remove-btn" onclick="removeNPC(this)">üóëÔ∏è</button>
    </div>
  `;
  if(data?.name) div.querySelector('.npc-name').value=data.name;
  div.querySelector('.npc-name').addEventListener('input',saveData);
  addAvatarLogic(div);
  div.querySelector('.npc-right').appendChild(createBlockRow('HP','hp', data?.hp));
  div.querySelector('.npc-right').appendChild(createBlockRow('Stress','stress', data?.stress));
  div.querySelector('.npc-right').appendChild(createHopeRow(data?.hope));
  document.getElementById('npc-container').appendChild(div);
  setTimeout(()=>div.classList.remove('fade-in'),300);
  saveData();
}

function removeNPC(btn){
  const div=btn.closest('.npc');
  div.classList.add('fade-out');
  setTimeout(()=>{ div.remove(); saveData(); },300);
}

// ===== –ó–∞–º–µ—Ç–∫–∏ =====
let noteCounter=0;
function addNoteTab(title,text){
  noteCounter++;
  const tab=document.createElement('div'); tab.className='tab fade-in';
  tab.textContent=title||'Tab '+noteCounter; tab.dataset.tab=noteCounter;
  const removeBtn=document.createElement('button'); removeBtn.className='remove-btn'; removeBtn.textContent='üóëÔ∏è'; removeBtn.onclick=()=>removeNoteTab(tab); 
  tab.appendChild(removeBtn);
  tab.addEventListener('click',()=>selectNoteTab(noteCounter));
  document.getElementById('notes-tabs').appendChild(tab);

  const content=document.createElement('div'); content.className='tab-content fade-in'; content.id='tab-content-'+noteCounter;
  const textarea=document.createElement('textarea'); if(text) textarea.value=text;
  textarea.addEventListener('input',saveData); content.appendChild(textarea);
  document.getElementById('notes-contents').appendChild(content);

  selectNoteTab(noteCounter);
  setTimeout(()=>{ tab.classList.remove('fade-in'); content.classList.remove('fade-in'); },300);
  saveData();
}

function removeNoteTab(tab){
  const id=tab.dataset.tab;
  const content=document.getElementById('tab-content-'+id);
  tab.classList.add('fade-out'); content.classList.add('fade-out');
  setTimeout(()=>{ tab.remove(); content.remove(); saveData(); },300);
}

function selectNoteTab(id){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  const tab=document.querySelector(`.tab[data-tab='${id}']`);
  if(tab) tab.classList.add('active');
  const content=document.getElementById('tab-content-'+id);
  if(content) setTimeout(()=>content.classList.add('active'),10); // –ø–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥
}

// ===== –°–≤–∞–π–ø—ã =====
const sections=['characters-section','npc-section','notes-section'];
let currentSection=0;

function showSectionWithAnimation() {
  sections.forEach((secId, idx) => {
    const sec = document.getElementById(secId);
    if(idx === currentSection) { sec.classList.add('active'); sec.style.transform='translateX(0)'; }
    else if(idx < currentSection) { sec.classList.remove('active'); sec.style.transform='translateX(-100%)'; }
    else { sec.classList.remove('active'); sec.style.transform='translateX(100%)'; }
  });
}

let startX=0; let isSwiping=false;
document.addEventListener('touchstart', e => { startX=e.touches[0].clientX; isSwiping=true; });
document.addEventListener('touchmove', e => {
  if(!isSwiping) return;
  const deltaX=e.touches[0].clientX-startX;
  sections.forEach((secId, idx) => {
    const sec=document.getElementById(secId);
    if(idx===currentSection) sec.style.transform=`translateX(${deltaX}px)`;
    if(idx===currentSection-1) sec.style.transform=`translateX(${deltaX-100}%)`;
    if(idx===currentSection+1) sec.style.transform=`translateX(${deltaX+100}%)`;
  });
});
document.addEventListener('touchend', e => {
  isSwiping=false;
  const delta=e.changedTouches[0].clientX-startX;
  if(delta>50 && currentSection>0) currentSection--;
  if(delta<-50 && currentSection<sections.length-1) currentSection++;
  showSectionWithAnimation();
});

document.addEventListener('keydown', e=>{
  if(e.key==='ArrowLeft' && currentSection>0){ currentSection--; showSectionWithAnimation();}
  if(e.key==='ArrowRight' && currentSection<sections.length-1){ currentSection++; showSectionWithAnimation();}
});

loadData();
showSectionWithAnimation();
</script>
</body>
</html>
